# 待处理问题

## 数据不均衡问题——紧急

由于标签不均衡，第三个、倒数第五个标签的比例分别为0.9，0.9，导致学习的过程中，这两个值基本被预测为1，其他的全部倾向于0，如下是使用Original、Segmented数据，训练了30个Epoch后，对Val进行预测的结果：

'my_output': array([[1.73255524e-14, 1.29659707e-03, 9.99820888e-01, 1.13264077e-11,
        8.29777273e-05, 7.33385561e-04, 1.29288066e-10, 3.33989283e-06,
        9.99999642e-01, 1.45883618e-07, 7.95193245e-09, 6.16776527e-14,
        1.08028235e-12],
       [5.44229971e-24, 8.75639955e-07, 9.99993682e-01, 3.19490839e-18,
        3.62233954e-09, 5.08854610e-05, 2.00667231e-19, 7.88219073e-11,
        1.00000000e+00, 3.89001467e-13, 2.58106459e-19, 2.85204262e-21,
        1.46501005e-16],
       [5.82149884e-24, 3.34603919e-06, 9.99999762e-01, 2.74838875e-19,
        1.58705927e-06, 1.84531501e-07, 1.69889613e-17, 8.40869475e-12,
        1.00000000e+00, 2.02899695e-13, 8.78627700e-15, 4.77588761e-22,
        1.85213515e-18],
       [8.67193253e-22, 4.67927239e-05, 9.99993682e-01, 8.73316198e-19,
        6.74705298e-05, 3.18978823e-06, 2.79685578e-15, 4.86659379e-10,
        1.00000000e+00, 1.62092666e-11, 1.89955596e-16, 1.93475667e-21,
        2.95958373e-15],
       [1.09179207e-18, 8.63464447e-05, 9.99956965e-01, 1.27800927e-16,
        2.47708090e-06, 3.35021214e-05, 5.21968102e-13, 2.94599090e-07,
        1.00000000e+00, 1.27435701e-10, 1.18900603e-13, 3.04629966e-19,
        2.98748775e-15],
       [1.30868954e-14, 2.51155780e-05, 9.99815762e-01, 3.56874686e-12,
        5.91327589e-05, 1.60903975e-04, 4.33566946e-13, 4.47841515e-08,
        9.99980330e-01, 1.62867908e-09, 7.31504510e-11, 3.66607948e-13,
        2.99221433e-12],



可能的方案：

1. 权重，根据标签的密度来给每一种标签的loss加权重（使用加权bce作为权重）

2. 标签分开训练，将比例差不多的标签放到一起训练（无法学到标签之间的关联关系）

3. 虽然部分标签的值很小，但是仍然是有变化的，依然可用使用阈值来进行切割。可用试试切割是否准确



实验：

1. 根据标签的密度，按照一下权重来对BCE LOSS进行加权

      ```
      527, 12.8, 1.1, 210, 2.8, 6.18, 279.32, 40.5, 1.11, 7.7, 14.79, 43.9, 156
      ```



## NAN问题

在evaluate和predict的时候，F2-Score为NaN，通过可视化发现，是模型的预测值，为NaN

+ 输出单元是Sigmoid，值域应该是 (0, 1)，说明在Sigmoid之前就出现了NAN
+ 网络采用预训练模型，仅仅修改了最后一层，因此应该不是网路结构异常
+ 该问题在使用BCE优化时容易出现，使用F2-SCORE优化时基本不出现
+ 只在针对没有见过的数据时会有这个问题？使用train数据进行evaluate试一下
+ 目前使用的是ResNet50，换一个模型试一下



查资料：

+ 大多数情况下是learning rate的问题
+ 可用通过tfdbg辅助查看问题
+ 通过summary权重来看是否有nan
+ 计算loss时对0、negative值进行下限剪切



实验：

+ 将学习率降低为0.0001，暂时没有出现NaN问题了



## Tensorflow 训练速度

目前的平均训练速度：

+ 使用Segmented数据，1.5 Step/Second
+ 使用Original数据，0.6 Step/Second



实验：

+ 对预训练网络的部分参数采用固定化，以减少全局需要训练的参数数量，InceptionV3网络可用稳定在 2.1 Step/Second



## 优化算法问题

+ SGD：在IncceptionV3中使用SGD，SGD(lr=1e-4, momentum=0.9)，效果还不错，可以进一步增大学习率试试



## 模型精度问题

ResNet50：

BCE Loss：可逐步优化到0.04以下，但是F2-Score经常NAN，且F2-Score很低（Val 集）

F2-Score Loss：短时间内优化到0.2，然后趋于平缓了，F2-Score metric在0.7~0.8左右（Val 集）

BCE+F2=SCORE：



实验：

+ 将学习率降低到0.0001，并使用BCE+F2-Score，训练过程的F2-Score可达到0.84，但是预测时只有0.56



## 阈值搜索问题

在进行Validation的时候，不应该直接看F2-Score，而应该先动态算出阈值，然后再计算